<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoundLab | Plataforma de Decisão Reputacional</title>
    <link rel="icon" href="https://foundlab.cloud/favicon.ico" type="image/x-icon">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Teko:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        /* Variáveis CSS para um tema consistente */
        :root {
            --primary-color: #FBBF24; /* Amber 400 */
            --primary-color-darker: #F59E0B; /* Amber 500 */
            --primary-color-light: #FCD34D; /* Amber 300 */
            --background-color: #111827; /* Gray 900 */
            --surface-color: #1F2937;    /* Gray 800 */
            --card-gradient-start: #1F2937;
            --card-gradient-end: #212d40;
            --text-color: #F9FAFB;       /* Gray 50 */
            --muted-text-color: #9CA3AF; /* Gray 400 */
            --border-color: rgba(251, 191, 36, 0.2);
            --module-border-color: #374151; /* Gray 700 */

            --success-color: #10B981; /* Emerald 500 */
            --success-bg: rgba(16, 185, 129, 0.15); /* Emerald 500 with opacity */
            --warning-color: #FBBF24; /* Amber 400 */
            --warning-bg: rgba(251, 191, 36, 0.15); /* Amber 400 with opacity */
            --danger-color: #EF4444;   /* Red 500 */
            --danger-bg: rgba(239, 68, 68, 0.15); /* Red 500 with opacity */
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            display: flex; 
            flex-direction: column;
            min-height: 100vh;
        }

        .font-title {
            font-family: 'Teko', sans-serif;
            letter-spacing: 0.05em;
        }

        .highlight-text { color: var(--primary-color); }

        .cta-button {
            background-color: var(--primary-color);
            color: #111827;
            font-family: 'Teko', sans-serif;
            font-weight: 600;
            font-size: 1.25rem;
            letter-spacing: 0.1em;
            border: 1px solid var(--primary-color);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px -5px rgba(251, 191, 36, 0.4);
            text-transform: uppercase;
        }

        .cta-button:hover:not(:disabled) {
            background-color: var(--primary-color-darker);
            box-shadow: 0 6px 20px -5px rgba(251, 191, 36, 0.6);
            transform: translateY(-2px);
        }
        .cta-button:disabled {
            background-color: #92400E; 
            color: #FDE68A;
            opacity: 0.7;
            cursor: wait;
        }

        .fade-in-section { opacity: 0; transform: translateY(30px); transition: opacity 0.8s cubic-bezier(0.25, 1, 0.5, 1), transform 0.8s cubic-bezier(0.25, 1, 0.5, 1); }
        .is-visible { opacity: 1; transform: translateY(0); }
        
        .card {
            border: 1px solid var(--module-border-color);
            background: linear-gradient(145deg, var(--card-gradient-start), var(--card-gradient-end));
            transition: border-color 0.5s ease, box-shadow 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
            transform: scaleX(0);
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            transform-origin: left;
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }

        .input-field {
            background-color: var(--background-color);
            border: 1px solid var(--module-border-color);
            color: var(--text-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.3);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }

        .evidence-tooltip {
            position: relative;
            cursor: help;
        }
        .evidence-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #000;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            font-family: 'Inter', sans-serif;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .evidence-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Score Circle Animation */
        .score-counter {
            font-variant-numeric: tabular-nums;
        }
        @keyframes pulse-light {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.9; }
        }
        .animate-pulse-light {
            animation: pulse-light 1.5s infinite ease-in-out;
        }

        /* Chart-like line for Score Trend */
        .chart-line {
            fill: none;
            stroke: var(--primary-color-light);
            stroke-width: 2;
            transition: stroke-dashoffset 2s ease-out;
        }
        .chart-marker {
            fill: var(--primary-color);
            r: 4;
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }
        .chart-grid-line {
            stroke: rgba(255,255,255,0.08);
            stroke-width: 0.5;
        }
        .chart-label-y {
            fill: var(--muted-text-color);
            font-size: 8px;
            text-anchor: end;
        }
        .chart-label-x {
            fill: var(--muted-text-color);
            font-size: 8px;
            text-anchor: middle;
        }

        /* Node Graph Visualization - SVG Based Nodes and Edges */
        .svg-node-circle {
            transition: all 0.5s ease-in-out;
            stroke-width: 2px;
            opacity: 0; 
        }
        .svg-node-text {
            font-size: 10px; 
            fill: var(--text-color);
            font-weight: 500;
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none; 
            opacity: 0; 
        }
        .svg-node-circle.wallet {
            fill: var(--primary-color);
            stroke: var(--primary-color-darker);
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
        }
        .svg-node-text.wallet {
            fill: black; 
        }
        .svg-node-circle.risk {
            fill: var(--danger-color);
            stroke: rgb(220, 38, 38); 
            filter: drop-shadow(0 0 6px rgba(239, 68, 68, 0.4));
        }
        .svg-node-circle.safe {
            fill: var(--success-color);
            stroke: rgb(5, 150, 105); 
            filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.4));
        }
        .svg-edge-line {
            stroke: var(--muted-text-color);
            stroke-width: 1.5;
            transition: all 0.5s ease-in-out;
            opacity: 0; 
        }
        .svg-edge-line.risk {
            stroke: var(--danger-color);
            stroke-width: 2;
            stroke-dasharray: 6 3; 
            animation: dash 1.5s linear infinite;
        }
        @keyframes dash {
            to {
                stroke-dashoffset: -10;
            }
        }

        /* Styles for Estimated Loss Block */
        .estimated-loss {
            background-color: var(--danger-bg);
            border: 1px solid var(--danger-color);
        }
        .estimated-loss .currency {
            color: var(--danger-color);
            font-size: 2.5rem; 
            font-weight: bold;
        }
        .estimated-loss .amount {
            color: var(--danger-color);
            font-size: 2.5rem; 
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }
        .estimated-loss .reason-text {
            color: rgba(255,255,255,0.7);
            font-size: 0.875rem;
        }
        .estimated-loss .sub-text {
            color: rgba(255,255,255,0.5);
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        /* Styles for Traditional Score Comparison */
        .traditional-score-block {
            background-color: var(--surface-color);
            border: 1px solid var(--module-border-color);
        }
        .traditional-score-block .score-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .traditional-score-block .label {
            font-size: 1rem;
            color: var(--muted-text-color);
        }
        .traditional-score-block .verdict {
            font-weight: bold;
            font-size: 1.25rem;
            margin-top: 0.5rem;
        }
        .traditional-score-block .action-text {
            font-size: 0.875rem;
            color: var(--muted-text-color);
        }

        /* Styles for No FoundLab Scenario */
        .no-foundlab-scenario {
            background-color: #2b1f1f; 
            border: 1px solid #7c1f1f; 
        }
        .no-foundlab-scenario .highlight {
            color: #ffcccc;
            font-weight: bold;
        }
        .no-foundlab-scenario .impact-value {
            color: #ef4444; 
            font-size: 2rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }
        .no-foundlab-scenario .time-value {
            color: #fca5a5; 
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Styles for Reverse Proof Section */
        .reverse-proof-section {
            background-color: #0d0d0d; /* Very dark background for contrast */
            border: 2px solid var(--danger-color);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            transition: opacity 1s ease-in-out;
        }
        .reverse-proof-section .danger-text {
            color: var(--danger-color);
        }
        .reverse-proof-section .critical-value {
            font-size: 3rem;
            font-weight: bold;
            color: var(--danger-color);
            font-variant-numeric: tabular-nums;
        }
        .reverse-proof-section .critical-label {
            font-size: 1.125rem;
            color: rgba(255,255,255,0.7);
        }
        .reverse-proof-section .time-to-detect {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--warning-color);
        }
        .reverse-proof-section.consequences-revealed #forceApproveButton {
            display: none;
        }

        /* Recommended Action for Review */
        .recommended-action-block {
            background-color: rgba(251, 191, 36, 0.1); /* Amber 400 with opacity */
            border: 1px solid var(--warning-color);
        }

        /* Why FoundLab Section */
        .why-foundlab-section .reason-card {
            background-color: var(--surface-color);
            border: 1px solid var(--module-border-color);
            transition: all 0.3s ease;
        }
        .why-foundlab-section .reason-card:hover {
            border-color: var(--primary-color-light);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
            transform: translateY(-3px);
        }
        .why-foundlab-section .reason-card .icon {
            font-size: 2.5rem;
            color: var(--primary-color);
        }
    </style>
</head>

<body class="antialiased">

    <div id="status-bar" class="fixed top-0 left-0 w-full bg-black/50 backdrop-blur-sm z-50 py-2 px-6 text-sm text-center text-gray-300 font-mono tracking-wider transition-opacity duration-300 opacity-0">
        Status: <span id="status-text">Ocioso</span>
    </div>

    <div class="container mx-auto max-w-7xl p-8 lg:p-12">
        
        <header class="text-center mb-12">
            <h2 class="font-title text-3xl text-gray-400">FOUNDLAB</h2>
            <h1 class="font-title text-5xl md:text-6xl highlight-text mt-2">Plataforma de Decisão Reputacional</h1>
            <p class="mt-4 text-lg text-[var(--muted-text-color)] max-w-3xl mx-auto">Infraestrutura de Score Reputacional em Tempo Real para Decisões Críticas de Risco.</p>
        </header>

        <section id="kpiSummary" class="fade-in-section card p-6 rounded-2xl shadow-xl mb-12 text-center" style="display: none;">
            <h3 class="font-title text-2xl highlight-text border-b border-[var(--border-color)] pb-3 mb-6">Métricas da Simulação (Acumulado)</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div>
                    <p class="text-3xl font-bold text-white"><span id="simulatedWallets">0</span></p>
                    <p class="text-sm text-gray-400">Carteiras Simuladas</p>
                </div>
                <div>
                    <p class="text-3xl font-bold text-white"><span id="blockVeredicts">0</span></p>
                    <p class="text-sm text-gray-400">Vereditos de Bloqueio</p>
                </div>
                <div>
                    <p class="text-3xl font-bold text-white"><span id="manualReviewsAvoided">0</span></p>
                    <p class="text-sm text-gray-400">Revisões Manuais Evitadas</p>
                </div>
                <div>
                    <p class="text-3xl font-bold text-green-400"><span id="potentialLossAvoided">R$ 0,00</span></p>
                    <p class="text-sm text-gray-400">Prejuízo Potencial Evitado</p>
                </div>
            </div>
        </section>

        <section id="userInputSection" class="card p-8 md:p-10 rounded-2xl shadow-2xl">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-2">1. INICIAR ANÁLISE DE RISCO</h3>
            <p class="text-sm text-[var(--muted-text-color)] italic mb-8">Forneça os dados da transação para iniciar a simulação de análise em tempo real.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="walletInput" class="block text-sm font-medium text-[var(--muted-text-color)] mb-2">Wallet Address</label>
                    <input type="text" id="walletInput" class="input-field w-full p-3 rounded-md" value="0x32FA1AC9823FFB768848132375C2B9DC0E98">
                </div>
                <div>
                    <label for="pixInput" class="block text-sm font-medium text-[var(--muted-text-color)] mb-2">ID da Transação PIX</label>
                    <input type="text" id="pixInput" class="input-field w-full p-3 rounded-md" value="E182361202406171530A1B2C3D4E5F6">
                </div>
                <div>
                    <label for="valueInput" class="block text-sm font-medium text-[var(--muted-text-color)] mb-2">Valor da Operação (USDC)</label>
                    <input type="number" id="valueInput" class="input-field w-full p-3 rounded-md" value="15000">
                </div>
            </div>
            <div class="flex justify-center mt-10">
                <button id="startAnalysisButton" class="cta-button py-4 px-10 rounded-md">
                    Analisar Transação
                </button>
            </div>
        </section>

        <div id="simulationContainer" class="space-y-12 mt-12">
            </div>

        <footer class="text-center mt-24 border-t border-[var(--border-color)] pt-8">
            <p class="text-sm text-[var(--muted-text-color)]">&copy; 2025 FoundLab. Todos os direitos reservados.</p>
        </footer>
    </div>
    
    <template id="simulation-template">
        <section id="inputData" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-2">2. DADOS DE ENTRADA</h3>
            <p class="text-sm text-[var(--muted-text-color)] italic mb-6">A plataforma captura os dados brutos da transação para iniciar a análise multicamadas.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="bg-[var(--background-color)] p-5 rounded-lg border border-[var(--module-border-color)]">
                    <span class="text-sm text-[var(--muted-text-color)]">Wallet Address</span>
                    <p id="displayWallet" class="font-mono text-amber-300 text-base mt-1 break-all"></p>
                </div>
                <div class="bg-[var(--background-color)] p-5 rounded-lg border border-[var(--module-border-color)]">
                    <span class="text-sm text-[var(--muted-text-color)]">Transação PIX</span>
                    <p id="displayPix" class="font-mono text-amber-300 text-base mt-1 break-all"></p>
                </div>
                <div class="bg-[var(--background-color)] p-5 rounded-lg border border-[var(--module-border-color)]">
                    <span class="text-sm text-[var(--muted-text-color)]">Operação Stablecoin</span>
                    <p id="displayValue" class="font-mono text-amber-300 text-base mt-1 break-all"></p>
                </div>
            </div>
        </section>

        <section id="networkViz" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-2">3. VISUALIZAÇÃO DE REDE DE RISCO</h3>
            <p class="text-sm text-[var(--muted-text-color)] italic mb-6">Explore as conexões e a propagação do risco através de uma visualização intuitiva de grafo.</p>
            <div class="relative w-full h-80 bg-gray-900 rounded-lg border border-[var(--module-border-color)] overflow-hidden flex items-center justify-center">
                <svg id="graph-svg" class="w-full h-full" viewBox="0 0 500 300" preserveAspectRatio="xMidYMid meet">
                    </svg>
            </div>
        </section>

        <section id="alertSignals" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-2">4. DOSSIÊS DE ALERTA</h3>
            <p class="text-sm text-[var(--muted-text-color)] italic mb-6">Os nossos agentes identificam e contextualizam imediatamente os primeiros indicadores de risco.</p>
            <div id="alert-tags" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </section>

        <section id="analysisModules" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-2">5. AGENTES DE IA EM OPERAÇÃO</h3>
            <p class="text-sm text-[var(--muted-text-color)] italic mb-6">Cada transação é avaliada pelos nossos agentes de IA especializados, cada um com um foco e fontes de dados distintas.</p>
            <div id="module-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-[var(--text-color)]"></div>
        </section>

        <section id="moduleProcessing" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-2">6. PROCESSAMENTO EM TEMPO REAL</h3>
            <p class="text-sm text-[var(--muted-text-color)] italic mb-8">Acompanhe como cada módulo reporta as suas descobertas e contribui com evidências para a análise final.</p>
            <div id="processing-grid" class="space-y-4"></div>
        </section>

        <section id="scoreDecision" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl" 
            x-data="{ scoreValue: 0, scoreTrendData: [], animateLine: false, currentScenario: {} }">
            <h3 class="font-title text-3xl highlight-text text-center border-b border-[var(--border-color)] pb-4 mb-2">7. VEREDITO ESTRATÉGICO JUSTIFICÁVEL</h3>
            <p class="text-sm text-center text-[var(--muted-text-color)] italic mb-8">O score é calculado por ponderação vetorial. Cada vetor ajusta a nota com base em dados operacionais. Não é uma média — é uma ponderação responsiva.</p>
            
            <div class="space-y-12">
                <div class="flex flex-col lg:flex-row items-center justify-around gap-12 mb-8">
                    <div class="relative w-40 h-40 flex-shrink-0">
                        <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                            <circle class="text-gray-700 stroke-current" stroke-width="10" cx="50" cy="50" r="40" fill="transparent"></circle>
                            <circle
                                class="text-[var(--primary-color-light)] stroke-current transition-all duration-500 ease-out"
                                stroke-width="10"
                                stroke-linecap="round"
                                cx="50"
                                cy="50"
                                r="40"
                                fill="transparent"
                                :stroke-dasharray="2 * Math.PI * 40"
                                :stroke-dashoffset="2 * Math.PI * 40 - (scoreValue / 100) * (2 * Math.PI * 40)"
                            ></circle>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                            <span class="text-5xl font-extrabold text-white score-counter" x-text="Math.round(scoreValue)"></span>
                            <span class="text-xs text-gray-400 mt-1">FoundScore™</span>
                        </div>
                    </div>
                    
                    <div id="verdict-summary" class="flex-grow max-w-sm mx-auto bg-black/20 p-6 rounded-lg border border-[var(--module-border-color)] flex flex-col justify-center items-center text-center">
                        </div>

                    <div id="estimated-loss-block" class="fade-in-section opacity-0 transition-opacity duration-500 delay-1000 p-6 rounded-lg shadow-md w-full max-w-xs text-center"
                         :class="{'estimated-loss': currentScenario.verdict !== 'approve'}"
                         x-show="currentScenario.verdict && currentScenario.verdict !== 'approve'">
                        <p class="text-md text-white mb-2">💸 Prejuízo Evitado Estimado:</p>
                        <p class="currency">R$ <span class="amount" id="animatedEstimatedLoss">0,00</span></p>
                        <p class="sub-text mt-4">Baseado em: Histórico de casos similares + valor transacionado.</p>
                        <p class="sub-text">"Estimativa com base em padrões de fraude mapeados pela FoundLab em gateways similares."</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                    <div class="text-center">
                        <h4 class="font-semibold text-lg text-gray-300 mb-4">Tendência Histórica do Score (Últimas 24h)</h4>
                        <div class="relative w-full h-48 bg-gray-900 rounded-lg border border-[var(--module-border-color)] px-4 py-6 flex items-center justify-center">
                            <svg class="absolute inset-0 w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <line x1="0" y1="20" x2="100" y2="20" class="chart-grid-line"></line>
                                <line x1="0" y1="50" x2="100" y2="50" class="chart-grid-line"></line>
                                <line x1="0" y1="80" x2="100" y2="80" class="chart-grid-line"></line>
                                <text x="-2" y="82" class="chart-label-y">20</text>
                                <text x="-2" y="52" class="chart-label-y">50</text>
                                <text x="-2" y="22" class="chart-label-y">80</text>
                                <text x="50" y="98" class="chart-label-x">Tempo</text>
                                <text x="98" y="5" class="chart-label-x" text-anchor="end">Score</text>

                                <path x-ref="scorePath" 
                                    :d="scoreTrendData.length > 0 ? 'M' + scoreTrendData.map((d, i) => `${(i / (scoreTrendData.length - 1)) * 100},${100 - d.score}`).join('L') : ''"
                                    class="chart-line" 
                                    :style="animateLine ? 'stroke-dashoffset: 0;' : 'stroke-dashoffset: ' + ($refs.scorePath ? $refs.scorePath.getTotalLength() : 0)"
                                ></path>
                                <template x-for="(point, index) in scoreTrendData">
                                    <circle 
                                        :cx="(index / (scoreTrendData.length - 1)) * 100" 
                                        :cy="100 - point.score" 
                                        :class="{'chart-marker': true, 'fill-red-500': point.anomaly, 'fill-amber-400': point.anomaly && point.anomalyType === 'peak'}"
                                        :style="point.anomaly ? 'opacity: 1;' : 'opacity: 0;'"
                                    >
                                        <title x-text="point.anomaly ? 'Anomalia: ' + point.anomalyType : ''"></title>
                                    </circle>
                                </template>
                            </svg>
                        </div>
                    </div>

                    <div id="traditional-score-comparison" class="fade-in-section opacity-0 transition-opacity duration-500 delay-1000 p-6 rounded-lg shadow-md h-full flex flex-col justify-center traditional-score-block">
                        <h4 class="font-semibold text-lg text-gray-300 mb-4 text-center">Comparativo de Score</h4>
                        <div class="flex justify-around items-center">
                            <div class="text-center">
                                <p class="score-value text-gray-300" x-text="currentScenario.traditionalScore"></p>
                                <p class="label">Score Tradicional</p>
                                <p class="verdict text-emerald-400">APROVADO</p>
                            </div>
                            <div class="text-center">
                                <p class="score-value text-[var(--primary-color)]" x-text="Math.round(currentScenario.score)"></p>
                                <p class="label">FoundLab Score</p>
                                <p class="verdict" :class="VERDICTS[currentScenario.verdict].textColor" x-text="currentScenario.verdict.toUpperCase()"></p>
                            </div>
                        </div>
                        <p class="text-center text-sm text-[var(--muted-text-color)] mt-6">
                            A FoundLab não replica scores tradicionais. <span class="text-white font-semibold">Ela corrige e aprofunda a análise.</span>
                        </p>
                    </div>
                </div>

                <div id="recommended-action-block" class="fade-in-section opacity-0 transition-opacity duration-500 delay-1000 p-6 rounded-lg shadow-md recommended-action-block hidden">
                    <h4 class="font-semibold text-lg text-amber-400 mb-2">Ação Recomendada para Análise Manual</h4>
                    <p class="text-sm text-gray-300"></p>
                </div>

                <div class="text-center">
                    <h4 class="font-semibold text-lg text-gray-300 mb-4">Matriz de Cálculo da Decisão</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full max-w-4xl mx-auto text-sm text-left">
                            <thead class="border-b-2 border-gray-700">
                                <tr class="font-mono text-xs text-gray-400 uppercase">
                                    <th class="py-2 px-2">Vetor</th>
                                    <th class="text-center py-2 px-2">Fontes dos Dados</th>
                                    <th class="text-center py-2 px-2">Base</th>
                                    <th class="text-center py-2 px-2">Ajustes Dinâmicos</th>
                                    <th class="text-center py-2 px-2">Score Final</th>
                                    <th class="text-center py-2 px-2">Peso</th>
                                </tr>
                            </thead>
                            <tbody id="decisionMatrix"></tbody>
                        </table>
                    </div>
                    <p id="calculationFormula" class="font-mono text-xs text-gray-500 mt-4"></p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                    <div class="text-center">
                        <h4 class="font-semibold text-lg text-gray-300 mb-4">Timeline dos Eventos que Impactaram a Pontuação</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead>
                                    <tr class="font-mono text-xs text-gray-400 uppercase">
                                        <th class="py-2 px-2">Módulo</th>
                                        <th class="py-2 px-2">Flag Identificada</th>
                                        <th class="text-right py-2 px-2">Impacto</th>
                                    </tr>
                                </thead>
                                <tbody id="eventsTimeline"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <h4 class="font-semibold text-lg text-gray-300 mb-4">Justificativa Auditável & Payload (APIs)</h4>
                        <div x-data="{ tab: 'justificativa' }" class="h-full bg-black/20 p-4 rounded-lg border border-[var(--module-border-color)] flex flex-col">
                            <div class="flex border-b border-gray-700 mb-4">
                                <button @click="tab = 'justificativa'" :class="{'border-[var(--primary-color)] text-[var(--primary-color)]': tab === 'justificativa', 'border-transparent text-gray-400 hover:text-gray-300': tab !== 'justificativa'}" class="py-2 px-4 border-b-2 font-medium text-sm transition duration-200">
                                    Justificativa Auditável
                                </button>
                                <button @click="tab = 'payload'" :class="{'border-[var(--primary-color)] text-[var(--primary-color)]': tab === 'payload', 'border-transparent text-gray-400 hover:text-gray-300': tab !== 'payload'}" class="py-2 px-4 border-b-2 font-medium text-sm transition duration-200">
                                    Payload de Integração
                                </button>
                            </div>

                            <div x-show="tab === 'justificativa'" x-transition.opacity.duration.300ms class="flex-grow space-y-3">
                                <p class="text-xs text-[var(--muted-text-color)]">Usado para documentação interna e comitê regulatório.</p>
                                <pre class="bg-gray-900 p-3 rounded-lg text-xs overflow-x-auto h-full code-block"><code>
{
  "verdict": "REVIEW",
  "score": 62.1,
  "reasons": [
    {
      "code": "UNVERIFIED_CONTRACT",
      "description": "Interação com smart contract recém-criado sem auditoria pública.",
      "severity": "MEDIUM",
      "source": "Sherlock"
    },
    {
      "code": "UNUSUAL_VOLUME",
      "description": "Volume da transação 3.5x superior à média histórica do utilizador.",
      "severity": "HIGH",
      "source": "Sentinela"
    },
    {
      "code": "RISKY_SOURCE",
      "description": "Fundos provenientes de exchange com políticas de KYC flexíveis.",
      "severity": "MEDIUM",
      "source": "Sherlock"
    },
    {
      "code": "KYC_VERIFIED",
      "description": "Verificação KYC bem-sucedida para o cliente.",
      "severity": "LOW",
      "source": "DFC"
    }
  ],
  "engine_version": "Score Engine v3.1",
  "timestamp": "2025-06-17T12:34:56Z"
}
                                </code></pre>
                                <button class="mt-4 cta-button py-2 px-4 text-xs rounded-md w-full">
                                    📄 Gerar justificativa PDF para Comitê de Risco
                                </button>
                            </div>

                            <div x-show="tab === 'payload'" x-transition.opacity.duration.300ms class="flex-grow space-y-3">
                                <p class="text-xs text-[var(--muted-text-color)]">Pronto para plugar diretamente no seu sistema ou pipeline de dados.</p>
                                <pre class="bg-gray-900 p-3 rounded-lg text-xs overflow-x-auto h-full code-block"><code>
{
  "transaction_id": "E182361202406171530A1B2C3D4E5F6",
  "wallet_address": "0x32FA1AC9823FFB768848132375C2B9DC0E98",
  "amount_usdc": 15000,
  "score": 62.1,
  "verdict": "REVIEW",
  "foundlab_flags": [
    "UNVERIFIED_CONTRACT",
    "UNUSUAL_VOLUME",
    "RISKY_SOURCE"
  ],
  "decision_timestamp": "2025-06-17T12:34:56Z",
  "recommendation": "Aguardar revisão manual ou solicitar informações adicionais.",
  "justification_link": "https://dashboard.foundlab.com/decision/${document.getElementById('pixInput').value}"
}
                                </code></pre>
                                <button class="mt-4 cta-button py-2 px-4 text-xs rounded-md w-full opacity-50 cursor-not-allowed">
                                    🔗 Testar integração via API (Mock)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="impactSection" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl text-left">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-2">8. RELATÓRIO DE PREVENÇÃO DE PERDAS</h3>
            <p class="text-sm text-[var(--muted-text-color)] italic mb-6">Demonstrando o valor tangível da FoundLab na proteção e otimização das suas operações.</p>
            <div id="impact-container"></div>
        </section>

        <section id="noFoundLabScenario" class="fade-in-section opacity-0 p-8 md:p-10 rounded-2xl shadow-xl text-center no-foundlab-scenario"
            x-data="{ currentScenario: {} }">
            <h3 class="font-title text-3xl text-white border-b border-red-500/30 pb-4 mb-2">Cenário Alternativo: <span class="highlight">Sem a FoundLab...</span></h3>
            <p class="text-sm text-red-200 italic mb-8">Visualizando as consequências sem a nossa infraestrutura de reputação em tempo real.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                <div>
                    <p class="text-white text-lg font-semibold mb-2">Processo Tradicional:</p>
                    <ul class="list-disc list-inside text-red-100 space-y-1">
                        <li>Carteira inicialmente aprovada.</li>
                        <li>Pagamento processado.</li>
                        <li>Fraude detectada <span class="highlight" x-text="currentScenario.noFoundLabDetectionTime"></span> depois (<span x-text="currentScenario.fraudTypeConfirmed"></span>).</li>
                    </ul>
                    <p class="text-white text-sm mt-4">Custos Ocultos Adicionais:</p>
                    <ul class="list-disc list-inside text-red-100 text-xs space-y-0.5">
                        <template x-for="cost in currentScenario.hiddenCosts">
                            <li x-text="cost"></li>
                        </template>
                    </ul>
                </div>
                <div class="text-right">
                    <p class="text-white text-lg font-semibold mb-2">Impacto Real:</p>
                    <p class="impact-value">R$ <span id="noFoundLabLoss" x-text="currentScenario.noFoundLabLoss.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })"></span></p>
                    <p class="text-red-200 text-sm">Perda Financeira Direta</p>
                    <p class="text-red-200 text-sm mt-2">Dano Reputacional e Operacional</p>
                </div>
            </div>
            <p class="text-red-300 text-lg font-semibold mt-10">
                <span class="text-red-400">Cada decisão em milissegundos</span> com a FoundLab <span class="text-red-400">evita um rombo em horas.</span>
            </p>
        </section>

        <section id="logSection" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl text-left">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-2">9. LIVE LOG DO MOTOR DE DECISÃO</h3>
            <p class="text-sm text-[var(--muted-text-color)] italic mb-6">Simulação do log do modelo, mostrando como o sistema pondera e corrige o veredito em tempo real.</p>
            <pre class="bg-black text-white p-4 rounded-lg overflow-x-auto text-sm h-72"><code id="decisionLog"></code></pre>
        </section>

        <section id="reverseProofSection" class="fade-in-section opacity-0 reverse-proof-section p-8 md:p-10 rounded-2xl shadow-xl text-center" 
            x-data="{ currentScenario: {} }">
            <h3 class="font-title text-3xl danger-text border-b border-[var(--danger-color)] pb-4 mb-2">PROVA REVERSA: SIMULAÇÃO DE DECISÃO MANUAL</h3>
            <p class="text-lg text-white mb-8">O que aconteceria se a decisão da FoundLab fosse ignorada?</p>
            
            <button id="forceApproveButton" class="cta-button py-4 px-12 rounded-lg text-xl hover:bg-red-700 bg-red-600 border-red-600 hover:border-red-700 transition-all duration-300">
                FORÇAR APROVAÇÃO E VER CONSEQUÊNCIAS
            </button>

            <div id="reverseProofConsequences" class="mt-10 opacity-0 transition-opacity duration-1000">
                <p class="text-white text-xl mb-4">DECISÃO FORÇADA: <span class="danger-text font-bold">APROVADA MANUALMENTE</span></p>
                <p class="text-white text-md mb-8">Ignorando os alertas da FoundLab...</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div>
                        <p class="critical-value">R$ <span id="rpLossAmount">0,00</span></p>
                        <p class="critical-label">Prejuízo Financeiro Direto</p>
                        <p class="text-lg text-gray-400 mt-4">Tipo de Fraude:</p>
                        <p class="text-2xl font-bold danger-text" id="rpFraudType"></p>
                    </div>
                    <div>
                        <p class="text-white text-lg mb-2">Problema Detectado Após:</p>
                        <p class="time-to-detect"><span id="rpDetectionTime">0h</span></p>
                        <p class="text-gray-400 text-sm">por meios tradicionais</p>
                        <p class="text-lg text-white mt-4">Impacto Adicional:</p>
                        <ul class="list-disc list-inside text-gray-300 text-sm space-y-1" id="rpHiddenCosts">
                        </ul>
                    </div>
                </div>
                <p class="text-white text-xl font-semibold mt-10">
                    A FoundLab previne o problema <span class="danger-text">antes que ele aconteça.</span>
                </p>
            </div>
        </section>

        <section id="whyFoundLabSection" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl text-center why-foundlab-section">
            <h3 class="font-title text-3xl highlight-text border-b border-[var(--border-color)] pb-4 mb-8">POR QUE FOUNDLAB? O SEU DIFERENCIAL.</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="reason-card p-6 rounded-lg flex flex-col items-center text-center">
                    <span class="icon mb-4">👁️</span>
                    <h4 class="font-bold text-lg text-white mb-2">Visão 360º de Risco</h4>
                    <p class="text-sm text-gray-400">Combina dados On-chain, Off-chain e Comportamento para uma análise completa.</p>
                </div>
                <div class="reason-card p-6 rounded-lg flex flex-col items-center text-center">
                    <span class="icon mb-4">🧠</span>
                    <h4 class="font-bold text-lg text-white mb-2">Inteligência Adaptativa</h4>
                    <p class="text-sm text-gray-400">Modelos de IA auto-otimizáveis que aprendem e se adaptam a novas fraudes.</p>
                </div>
                <div class="reason-card p-6 rounded-lg flex flex-col items-center text-center">
                    <span class="icon mb-4">📄</span>
                    <h4 class="font-bold text-lg text-white mb-2">Auditabilidade Total</h4>
                    <p class="text-sm text-gray-400">Cada decisão é rastreada, justificável e pronta para auditorias regulatórias.</p>
                </div>
                <div class="reason-card p-6 rounded-lg flex flex-col items-center text-center">
                    <span class="icon mb-4">📈</span>
                    <h4 class="font-bold text-lg text-white mb-2">Retorno Sobre Investimento</h4>
                    <p class="text-sm text-gray-400">Redução substancial de perdas, eficiência operacional e proteção de reputação.</p>
                </div>
            </div>
        </section>
        
        <section id="finalSummary" class="fade-in-section card p-8 md:p-10 rounded-2xl shadow-xl text-center">
            <h3 class="font-title text-3xl highlight-text text-center border-b border-[var(--border-color)] pb-4 mb-8">SIMULAÇÃO CONCLUÍDA</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-xl max-w-xl mx-auto">
                <div class="text-left"><span class="text-gray-400">Tempo de Análise:</span> <span class="text-white font-semibold">128ms</span></div>
                <div class="text-left"><span class="text-gray-400">Flags Identificadas:</span> <span class="text-white font-semibold">3</span></div>
                <div class="text-left"><span class="text-gray-400">Veredito Final:</span> <span id="finalVerdictText" class="text-amber-400 font-semibold">REVIEW</span></div>
                <div class="text-left"><span class="text-400">Score Final:</span> <span id="finalScoreText" class="text-white font-semibold">62.1</span></div>
            </div>
            <button id="restartSimulationButton" class="cta-button mt-10 py-3 px-8 rounded-md">
                Reiniciar Simulação
            </button>
        </section>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const startAnalysisButton = document.getElementById('startAnalysisButton');
        const userInputSection = document.getElementById('userInputSection');
        const simulationContainer = document.getElementById('simulationContainer');
        const simulationTemplate = document.getElementById('simulation-template');
        const statusBar = document.getElementById('status-bar');
        const statusText = document.getElementById('status-text');
        const kpiSummary = document.getElementById('kpiSummary'); 

        // Accumulators for KPIs
        let totalSimulatedWallets = 0;
        let totalBlockVeredicts = 0;
        let totalManualReviewsAvoided = 0;
        let totalPotentialLossAvoided = 0; // In R$

        let currentScenarioData = {}; // To store the current scenario's data for Alpine.js

        let isSimulating = false; 

        // Function to update global KPIs
        function updateGlobalKPIs() {
            document.getElementById('simulatedWallets').textContent = totalSimulatedWallets.toLocaleString();
            document.getElementById('blockVeredicts').textContent = totalBlockVeredicts.toLocaleString();
            document.getElementById('manualReviewsAvoided').textContent = totalManualReviewsAvoided.toLocaleString();
            document.getElementById('potentialLossAvoided').textContent = `R$ ${totalPotentialLossAvoided.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        const SCENARIOS = [
            { 
                score: 62.1, 
                verdict: 'review', 
                traditionalScore: 72, 
                estimatedLoss: 12400.00, 
                noFoundLabLoss: 8900.00, 
                noFoundLabDetectionTime: '26h',
                fraudTypeConfirmed: 'Lavagem de Dinheiro (Mixer)',
                hiddenCosts: ['Custos operacionais de reversão', 'Dano à reputação da marca', 'Multas regulatórias (potenciais)'],
                baseScores: { confianca: 80, conformidade: 75, comportamento: 60 },
                weights: { confianca: 0.4, conformidade: 0.3, comportamento: 0.3 },
                decisionRule: "REVISÃO MANUAL EXIGIDA",
                decisionRationale: "Conflito entre alto KYC e baixa confiabilidade comportamental",
                badgeText: "Evita falso positivo com defesa técnica estruturada",
                alerts: [
                    { title: 'Risco na Origem', description: 'Fundos provenientes de exchange com políticas de KYC flexíveis.', type: 'danger'}, 
                    { title: 'Volume Atípico', description: 'Transação 3.5x superior à média histórica do utilizador.', type: 'warning'}, 
                    { title: 'Contrato Não Verificado', description: 'Interação com smart contract recém-criado e sem auditoria pública.', type: 'warning'}
                ], 
                moduleDetails: [
                    { name: 'Sherlock', finding: '1 interação com contrato não auditado.', flag: 'UNVERIFIED_CONTRACT', impact: -8, evidence: 'Tx ID 0x94... operando com contrato recém-criado sem auditoria.', status: 'warning', remark: 'Risco Encontrado'},
                    { name: 'Sentinela', finding: 'Pico de volume acima da média histórica.', flag: 'UNUSUAL_VOLUME', impact: -15, evidence: 'Volume 3.5x superior à média dos últimos 90 dias.', status: 'warning', remark: 'Alerta Ativado'},
                    { name: 'Sherlock', finding: 'Interação com CEX de tier médio.', flag: 'RISKY_SOURCE', impact: -6, evidence: 'Fundos provenientes de exchange com políticas de KYC flexíveis.', status: 'warning', remark: 'Risco Encontrado'},
                    { name: 'DFC', finding: 'Verificação KYC bem-sucedida.', flag: 'KYC_VERIFIED', impact: 12, evidence: 'Documento ID 34823 validado com sucesso.', status: 'success', remark: 'Verificado'}
                ],
                networkGraph: {
                    nodes: [
                        { id: 'wallet_user', label: 'SUA WALLET', type: 'wallet', cx: 250, cy: 150, r: 40 }, 
                        { id: 'mixer_tornadocash', label: 'TORNADOCASH', type: 'risk', cx: 100, cy: 80, r: 30 },
                        { id: 'suspicious_exchange', label: 'EXCHANGE SUSP.', type: 'risk', cx: 400, cy: 80, r: 30 },
                        { id: 'new_contract', label: 'CONTRATO NAO AUD.', type: 'risk', cx: 250, cy: 240, r: 30 }
                    ],
                    edges: [
                        { from: 'wallet_user', to: 'mixer_tornadocash', type: 'risk' },
                        { from: 'wallet_user', to: 'suspicious_exchange', type: 'risk' },
                        { from: 'wallet_user', to: 'new_contract', type: 'risk' }
                    ]
                },
                scoreTrend: [
                    { score: 85, anomaly: false }, { score: 80, anomaly: false }, { score: 78, anomaly: false }, { score: 75, anomaly: false },
                    { score: 68, anomaly: true, anomalyType: 'queda abrupta' }, { score: 65, anomaly: false }, { score: 62.1, anomaly: false } 
                ],
                impact: { before: "Essa transação teria sido aprovada. O sistema antifraude tradicional não detecta contratos não verificados nem picos de volume contextuais.", with: "A IA detectou inconsistência e acionou revisão antes do processamento. O prejuízo potencial de US$ 15.000,00 foi evitado." },
                decisionLog: [
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:32:11Z", "message": "Iniciando análise..."},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:32:12Z", "message": "Flags detectadas: 3"},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:32:12Z", "message": "Ajustes totais: -17"},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:32:13Z", "message": "Veredito preliminar: BLOCK", "highlight": "text-red-400"},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:32:14Z", "message": "Correção por confiança (DFC): +12", "highlight": "text-emerald-400"},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:32:15Z", "message": "Veredito final: REVIEW", "highlight": "text-amber-400"}
                ],
                recommendedAction: { 
                    title: "Ação Recomendada para Análise Manual",
                    content: "Verificar interação com carteiras em blacklists globais e solicitar comprovante de origem dos fundos (Proof of Funds)."
                }
            },
            { 
                score: 95.0, 
                verdict: 'approve', 
                traditionalScore: 92, 
                estimatedLoss: 0, 
                noFoundLabLoss: 0,
                baseScores: { confianca: 90, conformidade: 95, comportamento: 98 },
                weights: { confianca: 0.4, conformidade: 0.3, comportamento: 0.3 },
                decisionRule: "APROVAÇÃO AUTOMÁTICA",
                decisionRationale: "Alta confiança e conformidade, sem sinais de risco",
                badgeText: "Transação aprovada com segurança",
                alerts: [
                    { title: 'KYC Completo', description: 'Identidade verificada e confirmada.', type: 'success'}, 
                    { title: 'Histórico Estável', description: 'Comportamento transacional consistente.', type: 'success'}
                ], 
                moduleDetails: [
                    { name: 'DFC', finding: 'Verificação KYC bem-sucedida.', flag: 'KYC_VERIFIED', impact: 10, evidence: 'Documento ID 34823 validado com sucesso.', status: 'success', remark: 'Verificado'},
                    { name: 'Sentinela', finding: 'Padrão de volume normal.', flag: 'NORMAL_VOLUME', impact: 5, evidence: 'Volume dentro da média histórica dos últimos 90 dias.', status: 'success', remark: 'Comportamento Preditivo'},
                    { name: 'Sherlock', finding: 'Endereço sem exposição a ilícitos.', flag: 'CLEAN_ADDRESS', impact: 5, evidence: 'Nenhuma ligação com entidades sancionadas ou ilícitas.', status: 'success', remark: 'Limpo'}
                ],
                networkGraph: {
                    nodes: [
                        { id: 'wallet_user', label: 'SUA WALLET', type: 'wallet', cx: 250, cy: 150, r: 40 },
                        { id: 'trusted_exchange', label: 'EXCHANGE CONFIÁVEL', type: 'safe', cx: 100, cy: 80, r: 30 },
                        { id: 'known_merchant', label: 'COMERCIANTE CONHECIDO', type: 'safe', cx: 400, cy: 80, r: 30 }
                    ],
                    edges: [
                        { from: 'wallet_user', to: 'trusted_exchange', type: 'safe' },
                        { from: 'wallet_user', to: 'known_merchant', type: 'safe' }
                    ]
                },
                scoreTrend: [
                    { score: 90, anomaly: false }, { score: 92, anomaly: false }, { score: 93, anomaly: false }, { score: 95, anomaly: false },
                    { score: 94, anomaly: false }, { score: 96, anomaly: false }, { score: 95.0, anomaly: false }
                ],
                impact: { before: "Essa transação seria aprovada de qualquer forma, mas sem a devida documentação e justificativa automatizada para auditoria.", with: "A FoundLab fornece a decisão instantânea e a documentação completa, auditável para conformidade regulatória, otimizando o fluxo operacional." },
                decisionLog: [
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:35:01Z", "message": "Iniciando análise..."},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:35:02Z", "message": "Flags detectadas: 0"},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:35:02Z", "message": "Ajustes totais: +20"},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:35:03Z", "message": "Veredito preliminar: APPROVE", "highlight": "text-emerald-400"},
                    { "modelo": "v2.3–FoundScoreEngine", "timestamp": "14:35:04Z", "message": "Veredito final: APPROVE", "highlight": "text-emerald-400"}
                ]
            }
        ];

        const VERDICTS = {
            approve: { color: 'var(--success-color)', textColor: 'text-emerald-400', badgeBg: 'bg-[var(--success-bg)]', badgeText: 'text-emerald-300', icon: '✅' },
            review: { color: 'var(--warning-color)', textColor: 'text-amber-400', badgeBg: 'bg-[var(--warning-bg)]', badgeText: 'text-amber-300', icon: '⚠️' },
            deny: { color: 'var(--danger-color)', textColor: 'text-red-400', badgeBg: 'bg-[var(--danger-bg)]', badgeText: 'text-red-300', icon: '🚫' }
        };

        let currentScenarioIndex = 0;
        let alpineScoreRef = null; 


        // Function to update global KPIs
        function updateGlobalKPIs() {
            document.getElementById('simulatedWallets').textContent = totalSimulatedWallets.toLocaleString();
            document.getElementById('blockVeredicts').textContent = totalBlockVeredicts.toLocaleString();
            document.getElementById('manualReviewsAvoided').textContent = totalManualReviewsAvoided.toLocaleString();
            document.getElementById('potentialLossAvoided').textContent = `R$ ${totalPotentialLossAvoided.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        const runSimulation = async () => {
            if (isSimulating) return; 
            isSimulating = true;

            // Reset UI for new simulation
            startAnalysisButton.disabled = true;
            userInputSection.classList.add('opacity-50', 'pointer-events-none');
            simulationContainer.innerHTML = ''; 
            statusBar.classList.remove('opacity-0');

            const simulationContent = simulationTemplate.content.cloneNode(true);
            simulationContainer.appendChild(simulationContent);
            
            // Set initial input values to display
            document.getElementById('displayWallet').textContent = document.getElementById('walletInput').value;
            document.getElementById('displayPix').textContent = document.getElementById('pixInput').value;
            document.getElementById('displayValue').textContent = `USDC: $${parseFloat(document.getElementById('valueInput').value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            // Map sections for easier access
            const sections = {
                inputData: document.getElementById('inputData'),
                networkViz: document.getElementById('networkViz'), 
                alertSignals: document.getElementById('alertSignals'),
                analysisModules: document.getElementById('analysisModules'),
                moduleProcessing: document.getElementById('moduleProcessing'),
                scoreDecision: document.getElementById('scoreDecision'),
                impactSection: document.getElementById('impactSection'),
                noFoundLabScenario: document.getElementById('noFoundLabScenario'), 
                logSection: document.getElementById('logSection'),
                reverseProofSection: document.getElementById('reverseProofSection'), 
                whyFoundLabSection: document.getElementById('whyFoundLabSection'), // NEW section
                finalSummary: document.getElementById('finalSummary')
            };

            // Pass currentScenario data to Alpine.js data for relevant sections
            currentScenarioData = SCENARIOS[currentScenarioIndex];
            sections.scoreDecision.setAttribute('x-data', `
                { 
                    scoreValue: 0, 
                    scoreTrendData: [], 
                    animateLine: false, 
                    currentScenario: ${JSON.stringify(currentScenarioData)}
                }
            `);
            sections.noFoundLabScenario.setAttribute('x-data', `
                { currentScenario: ${JSON.stringify(currentScenarioData)} }
            `);
            sections.reverseProofSection.setAttribute('x-data', `
                { currentScenario: ${JSON.stringify(currentScenarioData)} }
            `);


            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            const show = async (el, delay = 100) => { 
                if(el) { 
                    await wait(delay); 
                    el.classList.add('is-visible'); 
                    if (el.id !== 'finalSummary' && el.id !== 'whyFoundLabSection' && !isElementInViewport(el)) { // Only scroll if not already visible
                         el.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                    }
                } 
            };
            const updateStatus = async (text, delay = 1000) => { statusText.textContent = text; await wait(delay); };
            
            const currentScenario = currentScenarioData; // Use the data from x-data

            // Show KPI Summary Bar first if not already visible
            if (kpiSummary.style.display === 'none') {
                kpiSummary.style.display = 'block';
                await show(kpiSummary, 100);
                updateGlobalKPIs(); // Initial update with 0s
            }

            // Sequence of simulation steps
            await updateStatus("CONFIRMANDO DADOS DE ENTRADA...", 600);
            await show(sections.inputData);
            await wait(800);
            
            await updateStatus("MAPEANDO REDE DE RELAÇÕES (SHERLOCK)...", 800);
            await show(sections.networkViz);
            await createNetworkGraph(currentScenario.networkGraph);
            await wait(2000); 

            await updateStatus("COLETANDO SINAIS AVANÇADOS (DFC)...", 800);
            updateAlertsUI(currentScenario.alerts);
            await show(sections.alertSignals);
            await wait(1000);

            await updateStatus("INICIANDO AGENTES DE IA FOUNDLAB...", 800);
            updateModuleCards();
            await show(sections.analysisModules);
            await wait(1000);

            await updateStatus("PROCESSANDO EM TEMPO REAL...", 1000);
            await show(sections.moduleProcessing);
            await animateModuleProcessing(currentScenario.moduleDetails);
            await wait(1000);

            await updateStatus("CALCULANDO SCORE E VEREDITO (SCORE ENGINE)...", 1000);
            await show(sections.scoreDecision);
            alpineScoreRef = Alpine.$data(sections.scoreDecision); 

            animateScore(currentScenario.score); 
            animateScoreTrend(currentScenario.scoreTrend); 
            updateDecisionUI(currentScenario); 
            
            // Animate Estimated Loss if applicable
            if (currentScenario.verdict !== 'approve' && currentScenario.estimatedLoss > 0) {
                document.getElementById('estimated-loss-block').classList.remove('opacity-0');
                document.getElementById('estimated-loss-block').classList.add('is-visible');
                await animateNumber(0, currentScenario.estimatedLoss, 'animatedEstimatedLoss', 1000);
            }
            // Show Traditional Score Comparison
            document.getElementById('traditional-score-comparison').classList.remove('opacity-0');
            document.getElementById('traditional-score-comparison').classList.add('is-visible');
            
            // Show Recommended Action for Review
            const recommendedActionBlock = document.getElementById('recommended-action-block');
            if (currentScenario.verdict === 'review' && currentScenario.recommendedAction) {
                recommendedActionBlock.classList.remove('hidden', 'opacity-0');
                recommendedActionBlock.classList.add('is-visible');
                recommendedActionBlock.querySelector('h4').textContent = currentScenario.recommendedAction.title;
                recommendedActionBlock.querySelector('p').textContent = currentScenario.recommendedAction.content;
            } else if (recommendedActionBlock) {
                recommendedActionBlock.classList.add('hidden'); // Ensure it's hidden if not a review scenario
            }

            await wait(2500); // Allow time for all these elements to settle


            await updateStatus("GERANDO RELATÓRIO DE PREVENÇÃO DE PERDAS...", 800);
            updateImpactUI(currentScenario.impact)
            await show(sections.impactSection);
            await wait(1000);

            // Show "Without FoundLab" Scenario if verdict is not "approve"
            if (currentScenario.verdict !== 'approve') {
                await show(sections.noFoundLabScenario);
                // Ensure the noFoundLabLoss element's text is updated with animation
                await animateNumber(0, currentScenario.noFoundLabLoss, 'noFoundLabLoss', 1000);
                await wait(2000); // Give time for this impactful message
            }
            
            await updateStatus("FINALIZANDO LOG DO MOTOR DE DECISÃO...", 800);
            await show(sections.logSection);
            await updateLogUI(currentScenario.decisionLog);
            await wait(1000);

            // NEW: Prova Reversa: Simulação de Decisão Manual
            if (currentScenario.verdict !== 'approve') { 
                await updateStatus("Aguardando decisão manual...", 1000);
                await show(sections.reverseProofSection);
                
                const forceApproveButton = document.getElementById('forceApproveButton');
                const rpConsequences = document.getElementById('reverseProofConsequences');
                
                forceApproveButton.onclick = async () => {
                    forceApproveButton.disabled = true;
                    forceApproveButton.textContent = "SIMULANDO CONSEQUÊNCIAS...";
                    forceApproveButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                    forceApproveButton.classList.add('bg-gray-600', 'cursor-wait');

                    // Populate and animate consequences
                    document.getElementById('rpFraudType').textContent = currentScenario.fraudTypeConfirmed;
                    document.getElementById('rpDetectionTime').textContent = currentScenario.noFoundLabDetectionTime;
                    
                    const rpHiddenCostsList = document.getElementById('rpHiddenCosts');
                    rpHiddenCostsList.innerHTML = '';
                    currentScenario.hiddenCosts.forEach(cost => {
                        const li = document.createElement('li');
                        li.textContent = cost;
                        rpHiddenCostsList.appendChild(li);
                    });

                    await animateNumber(0, currentScenario.noFoundLabLoss, 'rpLossAmount', 1500, 'R$ '); 
                    
                    rpConsequences.classList.remove('opacity-0');
                    rpConsequences.classList.add('is-visible');
                    rpConsequences.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    sections.reverseProofSection.classList.add('consequences-revealed'); // Hide button

                    await wait(3000); 
                    
                    // Proceed to final summary
                    await updateStatus(`SIMULAÇÃO COMPLETA | VEREDITO: ${currentScenario.verdict.toUpperCase()} | SCORE: ${currentScenario.score.toFixed(1)}`, 500);
                    updateFinalSummary(currentScenario);
                    await show(sections.finalSummary);

                    // Update Global KPIs after simulation is complete
                    totalSimulatedWallets++;
                    if (currentScenario.verdict === 'deny') { 
                        totalBlockVeredicts++;
                        totalPotentialLossAvoided += currentScenario.estimatedLoss; 
                    } else if (currentScenario.verdict === 'review') { 
                        totalManualReviewsAvoided++; 
                        totalPotentialLossAvoided += currentScenario.estimatedLoss; 
                    }
                    updateGlobalKPIs(); 

                    startAnalysisButton.disabled = false;
                    userInputSection.classList.remove('opacity-50', 'pointer-events-none');
                    isSimulating = false; 
                };
                
                // Wait indefinitely until button is clicked or simulation restarted
                await new Promise(resolve => {
                    const restartHandler = () => { // Handler for restart button click
                        forceApproveButton.removeEventListener('click', resolve); // Remove its own listener
                        document.getElementById('restartSimulationButton').removeEventListener('click', restartHandler); // Remove this handler
                        resolve(); // Resolve the promise to continue simulation flow
                    };
                    forceApproveButton.addEventListener('click', resolve); // Listener for force approve button
                    document.getElementById('restartSimulationButton').addEventListener('click', restartHandler); // Listener for global restart button
                });

            } else { // If verdict is 'approve', skip reverse proof and go straight to final summary
                await updateStatus(`SIMULAÇÃO COMPLETA | VEREDITO: ${currentScenario.verdict.toUpperCase()} | SCORE: ${currentScenario.score.toFixed(1)}`, 500);
                updateFinalSummary(currentScenario);
                await show(sections.finalSummary);

                totalSimulatedWallets++;
                updateGlobalKPIs(); 

                startAnalysisButton.disabled = false;
                userInputSection.classList.remove('opacity-50', 'pointer-events-none');
                isSimulating = false; 
            }

            // NEW: Show "Why FoundLab" section before final summary or restart
            await show(sections.whyFoundLabSection, 500);
            await wait(2000); // Give time for this impactful section

            // Set up restart button for general flow (if not already handled by reverse proof)
            const restartButton = document.getElementById('restartSimulationButton');
            if (restartButton && !restartButton._hasClickListener) {
                restartButton._hasClickListener = true; // Prevent multiple listeners
                restartButton.addEventListener('click', () => {
                    simulationContainer.innerHTML = '';
                    statusBar.classList.add('opacity-0');
                    statusText.textContent = 'Ocioso';
                    userInputSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    currentScenarioIndex = (currentScenarioIndex + 1) % SCENARIOS.length; 
                });
            }
        };

        // Helper to check if an element is in the current viewport
        function isElementInViewport (el) {
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        // Helper to animate a number count
        function animateNumber(start, end, elementId, duration, prefix = '', suffix = '') {
            return new Promise(resolve => {
                const obj = document.getElementById(elementId);
                let startTime = null;

                const step = (currentTime) => {
                    if (!startTime) startTime = currentTime;
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    const currentValue = start + (end - start) * progress;
                    obj.textContent = prefix + currentValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + suffix;

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    } else {
                        obj.textContent = prefix + end.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + suffix;
                        resolve();
                    }
                };
                requestAnimationFrame(step);
            });
        }
        
        function updateAlertsUI(alerts){
            const container = document.getElementById("alert-tags");
            if (!container) return;
            container.innerHTML = "";
            const typeConfig = {
                danger: { icon: '✖', color: 'red-400', border: 'var(--danger-bg)' },
                warning: { icon: '!', color: 'amber-400', border: 'var(--warning-bg)' },
                success: { icon: '✓', color: 'emerald-400', border: 'var(--success-bg)' }
            };
            alerts.forEach(alert => {
                const config = typeConfig[alert.type];
                const el = document.createElement("div");
                el.className = `bg-black/20 p-4 rounded-lg border border-[${config.border}] fade-in-section is-visible`; 
                el.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-xl font-bold text-${config.color} mr-3">${config.icon}</span>
                        <h4 class="font-semibold text-white">${alert.title}</h4>
                    </div>
                    <p class="text-sm text-gray-400 mt-1 pl-8">${alert.description}</p>
                `;
                container.appendChild(el);
            });
        }
        
        function updateModuleCards(){
            const container = document.getElementById("module-cards");
            if (!container) return;
            container.innerHTML = `
                <div class="bg-[var(--surface-color)] p-6 rounded-lg border border-[var(--module-border-color)] h-full transition duration-300 hover:border-[var(--primary-color-light)] hover:shadow-lg">
                    <h4 class="font-bold text-lg text-amber-400">Sherlock <span class="text-xs text-gray-500 font-normal">v2.1</span></h4>
                    <p class="text-sm mt-1 text-gray-400">Analisa o histórico e o comportamento on-chain da entidade para detetar padrões suspeitos, como o uso de mixers ou interações com contratos de risco.</p>
                    <p class="text-xs mt-3 font-mono text-gray-500">Fontes: Etherscan, Polygonscan, Fontes On-chain</p>
                </div>
                <div class="bg-[var(--surface-color)] p-6 rounded-lg border border-[var(--module-border-color)] h-full transition duration-300 hover:border-[var(--primary-color-light)] hover:shadow-lg">
                    <h4 class="font-bold text-lg text-amber-400">DFC (Dynamic Flag Council) <span class="text-xs text-gray-500 font-normal">v1.8</span></h4>
                    <p class="text-sm mt-1 text-gray-400">Realiza o cruzamento de dados com listas de sanções globais (OFAC, Interpol) e verifica a identidade (KYC) para garantir conformidade regulatória.</p>
                    <p class="text-xs mt-3 font-mono text-gray-500">Fontes: OFAC, Listas de Sanções, Fontes Internas</p>
                </div>
                <div class="bg-[var(--surface-color)] p-6 rounded-lg border border-[var(--module-border-color)] h-full transition duration-300 hover:border-[var(--primary-color-light)] hover:shadow-lg">
                    <h4 class="font-bold text-lg text-amber-400">Sentinela <span class="text-xs text-gray-500 font-normal">v3.0</span></h4>
                    <p class="text-sm mt-1 text-gray-400">Monitora o comportamento transacional em tempo real, detetando anomalias como picos de volume ou frequência que destoam do perfil histórico.</p>
                    <p class="text-xs mt-3 font-mono text-gray-500">Fontes: Histórico Transacional, Análise Preditiva</p>
                </div>
            `;
        }

        async function animateModuleProcessing(moduleDetails){
            const container = document.getElementById("processing-grid");
            if (!container) return;
            container.innerHTML = "";
            const wait = ms => new Promise(res => setTimeout(res, ms));
            const statusClasses = {
                success: { text: "text-emerald-400", icon: "✓" },
                warning: { text: "text-amber-400", icon: "!" },
                danger: { text: "text-red-400", icon: "X" }
            };
            
            for(const mod of moduleDetails) {
                const el = document.createElement("div");
                el.className = "opacity-0"; 

                // Initial loading state
                el.innerHTML = `<div class="flex items-center gap-5 p-4 bg-gray-900 rounded-lg shadow-md border border-[var(--module-border-color)]"><div class="flex-grow"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-lg text-white">${mod.name}</h4><span class="font-mono text-xs px-2 py-1 rounded bg-gray-700 text-gray-300">PROCESSANDO...</span></div><div class="flex justify-between items-end"><p class="text-sm text-[var(--muted-text-color)]">Aguardando resultados...</p><div class="w-5 h-5 border-2 border-gray-400 border-t-transparent rounded-full spinner"></div></div></div></div>`;
                container.appendChild(el);
                
                await wait(200); 
                el.style.transition = "opacity 0.3s ease-in-out";
                el.style.opacity = "1";
                el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                await wait(1000); 

                // Final state
                const pointsClass = mod.impact >= 0 ? "text-emerald-400" : "text-red-400";
                const pointsSign = mod.impact > 0 ? "+" : "";
                
                el.innerHTML = `<div class="flex items-center gap-5 p-4 bg-black/20 rounded-lg shadow-md border border-[var(--module-border-color)]"><div class="flex-grow"><div class="flex justify-between items-center mb-2"><h4 class="font-bold text-lg text-white">${mod.name}</h4><span class="font-mono text-xs px-2 py-1 rounded bg-gray-900">${mod.flag}</span></div><div class="flex justify-between items-end"><p class="text-sm text-[var(--muted-text-color)]">${mod.finding}</p><p class="font-semibold text-lg ${pointsClass}">${pointsSign}${mod.impact} pts</p></div></div><div class="text-center w-24 flex-shrink-0"><div class="w-10 h-10 mx-auto flex items-center justify-center rounded-full text-2xl font-bold ${statusClasses[mod.status].text}">${statusClasses[mod.status].icon}</div><p class="text-xs mt-2 font-semibold ${statusClasses[mod.status].text}">${mod.remark}</p></div></div>`;
            }
        }
        
        function animateScore(finalScore) {
            let start = 0;
            const end = finalScore;
            const duration = 1000; 
            let startTime = null;

            const animate = (currentTime) => {
                if (!startTime) startTime = currentTime;
                const progress = Math.min((currentTime - startTime) / duration, 1);
                
                if (alpineScoreRef) {
                    alpineScoreRef.scoreValue = start + progress * (end - start);
                }

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    if (alpineScoreRef) {
                        alpineScoreRef.scoreValue = end; 
                    }
                }
            };
            requestAnimationFrame(animate);
        }

        function animateScoreTrend(data) {
            if (!alpineScoreRef) return;
            
            alpineScoreRef.scoreTrendData = JSON.parse(JSON.stringify(data)); 
            
            Alpine.nextTick(() => {
                if (alpineScoreRef.$refs.scorePath) { 
                    const pathElement = alpineScoreRef.$refs.scorePath;
                    const length = pathElement.getTotalLength();
                    pathElement.style.strokeDasharray = length;
                    pathElement.style.strokeDashoffset = length;
                    
                    setTimeout(() => {
                        alpineScoreRef.animateLine = true;
                    }, 100);
                }
            });
        }


        function updateDecisionUI(result) {
            const matrixBody = document.getElementById('decisionMatrix');
            const formulaEl = document.getElementById('calculationFormula');
            const timelineBody = document.getElementById('eventsTimeline');
            const verdictSummaryContainer = document.getElementById('verdict-summary');
            
            if(!matrixBody || !formulaEl || !timelineBody || !verdictSummaryContainer) return;

            matrixBody.innerHTML = '';
            let formula = '(';
            const vectors = {confianca: 'Confiança', conformidade: 'Conformidade', comportamento: 'Comportamento'};
            
            Object.keys(vectors).forEach((key, index) => {
                const base = result.baseScores[key];
                const adjustments = result.moduleDetails.filter(m => {
                    const flag = m.flag.toLowerCase();
                    if (key === 'confianca') return m.name === 'DFC'; 
                    if (key === 'conformidade') return false; 
                    if (key === 'comportamento') return m.name === 'Sherlock' || m.name === 'Sentinela'; 
                    return false;
                }).reduce((acc, curr) => acc + curr.impact, 0);

                const final = base + adjustments;
                const weight = result.weights[key];

                const sources = [...new Set(result.moduleDetails.filter(m => {
                    const flag = m.flag.toLowerCase();
                    if (key === 'confianca') return m.name === 'DFC';
                    if (key === 'conformidade') return false; 
                    if (key === 'comportamento') return m.name === 'Sherlock' || m.name === 'Sentinela';
                    return false;
                }).map(m => m.name))].join(', ');
                
                let dynamicImpactText = adjustments !== 0 ? `${adjustments > 0 ? '+' : ''}${adjustments}` : '-';
                let dynamicImpactColor = adjustments >= 0 ? 'text-emerald-400' : 'text-red-400';
                if (adjustments === 0) dynamicImpactColor = 'text-gray-400';


                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700/50 h-14';
                row.innerHTML = `
                    <td class="py-2 px-2 font-semibold text-left text-white">${vectors[key]}</td>
                    <td class="py-2 px-2 text-gray-400 text-xs text-center">${sources || 'N/A'}</td>
                    <td class="py-2 px-2 font-mono text-center">${base}</td>
                    <td class="py-2 px-2 font-mono text-center ${dynamicImpactColor}">${dynamicImpactText}</td>
                    <td class="py-2 px-2 font-bold text-xl text-white text-center">${final}</td>
                    <td class="py-2 px-2 text-gray-400 font-mono text-center">${weight}</td>
                `;
                matrixBody.appendChild(row);
                
                formula += `(${final} × ${weight})${index < Object.keys(vectors).length - 1 ? ' + ' : ''}`;
            });

            formula += `) = ${result.score.toFixed(1)}`;
            formulaEl.textContent = `Fórmula: ${formula}`;

            timelineBody.innerHTML = '';
            result.moduleDetails.forEach(mod => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700/50 h-14';
                    row.innerHTML = `<td class="py-2 px-2 font-semibold">${mod.name}</td><td class="py-2 px-2 text-gray-400 evidence-tooltip">${mod.flag}<span class="tooltip-text">${mod.evidence}</span></td><td class="py-2 px-2 font-bold text-right ${mod.impact >= 0 ? 'text-emerald-400' : 'text-red-400'}">${mod.impact > 0 ? '+' : ''}${mod.impact} pts</td>`;
                    timelineBody.appendChild(row);
            });

            const verdictConfig = VERDICTS[result.verdict];
            verdictSummaryContainer.innerHTML = `
                <div class="text-6xl mb-4">${verdictConfig.icon}</div>
                <p class="text-2xl font-bold ${verdictConfig.textColor}">${result.decisionRule}</p>
                <p class="text-md text-gray-400 mt-2">${result.decisionRationale}</p>
                <div class="inline-block mt-4 font-bold py-2 px-5 rounded-full text-sm uppercase tracking-wider ${verdictConfig.badgeBg} ${verdictConfig.badgeText} animate-pulse-light">
                    ${result.badgeText}
                </div>
            `;

            // Update JSON content for justified tab
            const justifiedJsonEl = verdictSummaryContainer.closest('section').querySelector('#justificativa pre code');
            if (justifiedJsonEl) {
                const justifiedData = {
                    verdict: result.verdict.toUpperCase(),
                    score: result.score,
                    reasons: result.moduleDetails.map(m => ({
                        code: m.flag,
                        description: m.finding + '.',
                        severity: m.status.toUpperCase(),
                        source: m.name
                    })),
                    engine_version: "Score Engine v3.1",
                    timestamp: new Date().toISOString().slice(0, 19) + 'Z' 
                };
                justifiedJsonEl.textContent = JSON.stringify(justifiedData, null, 2);
            }

            // Update JSON content for payload tab
            const payloadJsonEl = verdictSummaryContainer.closest('section').querySelector('#payload pre code');
            if (payloadJsonEl) {
                const payloadData = {
                    transaction_id: document.getElementById('pixInput').value,
                    wallet_address: document.getElementById('walletInput').value,
                    amount_usdc: parseFloat(document.getElementById('valueInput').value),
                    score: result.score,
                    verdict: result.verdict.toUpperCase(),
                    foundlab_flags: result.moduleDetails.filter(m => m.status !== 'success').map(m => m.flag),
                    decision_timestamp: new Date().toISOString().slice(0, 19) + 'Z', 
                    recommendation: result.verdict === 'review' ? "Aguardar revisão manual ou solicitar informações adicionais." : (result.verdict === 'approve' ? "Transação aprovada. Prossiga." : "Transação bloqueada. Alerta crítico."),
                    justification_link: `https://dashboard.foundlab.com/decision/${document.getElementById('pixInput').value}`
                };
                payloadJsonEl.textContent = JSON.stringify(payloadData, null, 2);
            }

            // Update recommended action for review scenarios
            const recommendedActionBlock = document.getElementById('recommended-action-block');
            if (result.verdict === 'review' && result.recommendedAction) {
                // This block is managed by Alpine.js x-show, so no need for classlist.remove('hidden')
                // Its visibility is handled by x-show="currentScenario.verdict === 'review' && currentScenario.recommendedAction"
                // Just update its content
                if (recommendedActionBlock) {
                    recommendedActionBlock.querySelector('h4').textContent = result.recommendedAction.title;
                    recommendedActionBlock.querySelector('p').textContent = result.recommendedAction.content;
                    recommendedActionBlock.classList.remove('opacity-0'); // Ensure it fades in
                    recommendedActionBlock.classList.add('is-visible');
                }
            } else if (recommendedActionBlock) {
                recommendedActionBlock.classList.add('opacity-0'); // Ensure it fades out
                recommendedActionBlock.classList.remove('is-visible');
            }
        }

        function updateImpactUI(impact){
            const container = document.getElementById('impact-container');
            if(!container) return;
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-[var(--danger-bg)] p-6 rounded-lg border border-red-500/30">
                        <h4 class="font-semibold text-red-400 mb-2">Antes da FoundLab</h4>
                        <p class="text-gray-400">${impact.before}</p>
                    </div>
                    <div class="bg-[var(--success-bg)] p-6 rounded-lg border border-emerald-500/30">
                        <h4 class="font-semibold text-emerald-400 mb-2">Com a FoundLab</h4>
                        <p class="text-gray-400">${impact.with}</p>
                    </div>
                </div>
            `;
        }
        
        async function updateLogUI(log) {
            const el = document.getElementById('decisionLog');
            if (!el) return;
            el.innerHTML = '';
            const wait = ms => new Promise(res => setTimeout(res, ms));
            for (const line of log) {
                const p = document.createElement('p');
                p.className = `transition-opacity duration-300 opacity-0`; 
                p.innerHTML = `<span class="text-gray-500">${line.timestamp}</span> [${line.modelo}]: <span class="${line.highlight || ''}">${line.message}</span>`;
                el.appendChild(p);
                el.scrollTop = el.scrollHeight; 
                await wait(70); 
                p.classList.remove('opacity-0');
            }
        }

        function updateFinalSummary(scenario) {
            document.getElementById('finalVerdictText').textContent = scenario.verdict.toUpperCase();
            document.getElementById('finalScoreText').textContent = scenario.score.toFixed(1);
            
            const finalVerdictElement = document.getElementById('finalVerdictText');
            if (scenario.verdict === 'review') {
                finalVerdictElement.className = 'text-amber-400 font-semibold';
            } else if (scenario.verdict === 'approve') {
                finalVerdictElement.className = 'text-emerald-400 font-semibold';
            } else if (scenario.verdict === 'deny') {
                finalVerdictElement.className = 'text-red-400 font-semibold';
            }
        }

        // --- Network Graph Visualization ---
        async function createNetworkGraph(graphData) {
            const svg = document.getElementById('graph-svg');
            if (!svg) return;

            svg.innerHTML = ''; // Clear previous graph content

            const nodesMap = new Map();

            // Create nodes (SVG circles and text)
            for (const nodeData of graphData.nodes) {
                // Node Circle
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute('id', `svg-node-${nodeData.id}`);
                circle.setAttribute('cx', nodeData.cx);
                circle.setAttribute('cy', nodeData.cy);
                circle.setAttribute('r', nodeData.r);
                circle.setAttribute('class', `svg-node-circle ${nodeData.type}`);
                svg.appendChild(circle);
                
                // Node Text
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute('x', nodeData.cx);
                text.setAttribute('y', nodeData.cy);
                text.setAttribute('class', `svg-node-text ${nodeData.type}`);
                text.textContent = nodeData.label;
                svg.appendChild(text);

                nodesMap.set(nodeData.id, { circle: circle, text: text, x: nodeData.cx, y: nodeData.cy, r: nodeData.r });
                
                // Animate node appearance
                await new Promise(resolve => setTimeout(resolve, 150)); // Stagger
                circle.style.opacity = 1;
                text.style.opacity = 1;
            }

            // Create edges (SVG lines)
            for (const edgeData of graphData.edges) {
                const fromNode = nodesMap.get(edgeData.from);
                const toNode = nodesMap.get(edgeData.to);

                if (fromNode && toNode) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute('x1', fromNode.x);
                    line.setAttribute('y1', fromNode.y);
                    line.setAttribute('x2', toNode.x);
                    line.setAttribute('y2', toNode.y);
                    line.setAttribute('class', `svg-edge-line ${edgeData.type === 'risk' ? 'risk' : ''}`);
                    svg.insertBefore(line, svg.firstChild); // Insert lines before circles so they don't cover text

                    // Animate line drawing
                    const length = Math.sqrt(Math.pow(toNode.x - fromNode.x, 2) + Math.pow(toNode.y - fromNode.y, 2));
                    line.style.strokeDasharray = length;
                    line.style.strokeDashoffset = length;

                    await new Promise(resolve => setTimeout(resolve, 200)); // Stagger
                    line.style.opacity = 1; // Make line visible
                    line.style.strokeDashoffset = 0; // Animate drawing
                }
            }
        }

        startAnalysisButton.addEventListener('click', runSimulation);

        // Initial KPI update when page loads
        updateGlobalKPIs();
    });
    </script>
</body>
</html>